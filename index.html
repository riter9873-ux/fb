<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { 
  getFirestore,
  addDoc,
  collection,
  onSnapshot,
  query,
  orderBy,
  updateDoc,
  doc,
  arrayUnion
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB3lYDIr8ElAWk-jwnOWxubtVS-TeSSyOg",
  authDomain: "uyguy-ab047.firebaseapp.com",
  projectId: "uyguy-ab047",
  storageBucket: "uyguy-ab047.firebasestorage.app",
  messagingSenderId: "297739792713",
  appId: "1:297739792713:web:72af3ba75fabcacb3caa98"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// PAGE
function showPage(page){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById(page).style.display="block";
}
window.showPage = showPage;

// LOGIN
window.login = ()=>{
  signInWithEmailAndPassword(auth,loginEmail.value,loginPass.value)
  .then(()=> showPage("home"))
  .catch(err=> msg.innerText = err.message);
}

// SIGNUP
window.signup = ()=>{
  createUserWithEmailAndPassword(auth,signupEmail.value,signupPass.value)
  .then(()=> showPage("home"))
  .catch(err=> alert(err.message));
}

// LOGOUT
window.logout = ()=>{
  signOut(auth).then(()=> showPage("login"));
}

// ADD POST
window.addPost = async ()=>{
  if(!postInput.value) return;

  await addDoc(collection(db,"posts"),{
    text: postInput.value,
    email: auth.currentUser.email,
    time: Date.now(),
    likes: [],
    comments: []
  });

  postInput.value = "";
}

// ğŸ‘ LIKE
window.likePost = async (id)=>{
  const ref = doc(db,"posts",id);

  await updateDoc(ref,{
    likes: arrayUnion(auth.currentUser.email)
  });
}

// ğŸ’¬ COMMENT
window.commentPost = async (id)=>{
  const text = prompt("Write comment:");
  if(!text) return;

  const ref = doc(db,"posts",id);

  await updateDoc(ref,{
    comments: arrayUnion({
      user: auth.currentUser.email,
      text: text
    })
  });
}

// ğŸ”¥ REALTIME POSTS
function loadPosts(){
  const q = query(collection(db,"posts"), orderBy("time","desc"));

  onSnapshot(q,(snap)=>{
    posts.innerHTML = "";

    snap.forEach(docSnap=>{
      const p = docSnap.data();
      const id = docSnap.id;

      posts.innerHTML += `
        <div class="post">
          <b>${p.email}</b>
          <p>${p.text}</p>

          <button onclick="likePost('${id}')">
            ğŸ‘ ${p.likes.length}
          </button>

          <button onclick="commentPost('${id}')">
            ğŸ’¬ ${p.comments.length}
          </button>

          <div>
            ${p.comments.map(c=> `<p><b>${c.user}</b>: ${c.text}</p>`).join("")}
          </div>
        </div>
      `;
    });
  });
}

// AUTH
onAuthStateChanged(auth,user=>{
  if(user){
    userEmail.innerText = user.email;
    profileEmail.innerText = user.email;
    showPage("home");
    loadPosts();
  }else{
    showPage("login");
  }
});

</script>
